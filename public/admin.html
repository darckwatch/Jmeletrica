<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Painel Administrativo | JM Elétrica</title>
  
  <!-- Tailwind CSS, Fonts, Icons -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/feather-icons"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* ... (os seus estilos CSS permanecem os mesmos) ... */
    body { font-family: 'Inter', sans-serif; background-color: #111827; color: #F3F4F6; }
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #1f2937; }
    ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; }
    .sidebar-link.active { background-color: #facc15; color: #111827; font-weight: 600; }
    .modal-backdrop { transition: opacity 0.3s ease; }
    .modal-content { transition: transform 0.3s ease; }
    .status-badge { padding: 4px 12px; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
    .status-disponivel { background-color: rgba(52, 211, 153, 0.1); color: #34d399; }
    .status-alugada { background-color: rgba(251, 146, 60, 0.1); color: #fb923c; }
    .status-manutencao { background-color: rgba(248, 113, 113, 0.1); color: #f87171; }
    .gallery-image-container { position: relative; }
    .gallery-image-overlay { position: absolute; top: 0; right: 0; bottom: 0; left: 0; background-color: rgba(0,0,0,0.5); opacity: 0; transition: opacity 0.2s ease-in-out; display: flex; align-items: center; justify-content: center; }
    .gallery-image-container:hover .gallery-image-overlay { opacity: 1; }
  </style>
</head>
<body class="antialiased">

  <div class="flex h-screen bg-gray-900">
    <!-- Sidebar Navigation -->
    <aside id="sidebar" class="w-64 bg-gray-800 border-r border-yellow-500/20 flex-shrink-0 flex-col transition-transform duration-300 ease-in-out md:flex -translate-x-full md:translate-x-0 fixed md:relative z-40 h-full">
      <div class="h-20 flex items-center justify-center border-b border-gray-700">
        <a href="#" class="text-3xl font-bold text-yellow-400">
          JM Elétrica <span class="text-lg font-normal text-gray-400 block -mt-2 text-center">Admin</span>
        </a>
      </div>
      <nav class="flex-1 px-4 py-6 space-y-2">
        <a href="#dashboard" class="sidebar-link active flex items-center px-4 py-3 rounded-lg text-gray-300 hover:bg-gray-700 transition-colors"><i data-feather="home" class="h-5 w-5 mr-3"></i> Dashboard</a>
        <a href="#servicos" class="sidebar-link flex items-center px-4 py-3 rounded-lg text-gray-300 hover:bg-gray-700 transition-colors"><i data-feather="tool" class="h-5 w-5 mr-3"></i> Serviços</a>
        <a href="#aluguel" class="sidebar-link flex items-center px-4 py-3 rounded-lg text-gray-300 hover:bg-gray-700 transition-colors"><i data-feather="truck" class="h-5 w-5 mr-3"></i> Aluguel</a>
        <a href="#galeria" class="sidebar-link flex items-center px-4 py-3 rounded-lg text-gray-300 hover:bg-gray-700 transition-colors"><i data-feather="image" class="h-5 w-5 mr-3"></i> Galeria</a>
        <a href="#diagnosticos" class="sidebar-link flex items-center px-4 py-3 rounded-lg text-gray-300 hover:bg-gray-700 transition-colors"><i data-feather="cpu" class="h-5 w-5 mr-3"></i> Diagnósticos IA</a>
        <a href="#configuracoes" class="sidebar-link flex items-center px-4 py-3 rounded-lg text-gray-300 hover:bg-gray-700 transition-colors"><i data-feather="settings" class="h-5 w-5 mr-3"></i> Configurações</a>
      </nav>
      <div class="p-4 border-t border-gray-700">
        <div class="flex items-center">
          <img id="user-avatar" class="h-10 w-10 rounded-full object-cover" src="https://placehold.co/100x100/1f2937/facc15?text=A" alt="[Avatar do Admin]">
          <div class="ml-3">
            <p id="user-name" class="text-sm font-semibold text-white">Admin</p>
            <a href="#" id="logout-btn" class="text-xs text-red-400 hover:text-red-300">Sair</a>
          </div>
        </div>
      </div>
    </aside>

    <!-- Main Content Area -->
    <div class="flex-1 flex flex-col overflow-hidden">
      <!-- Header -->
      <header class="h-20 bg-gray-800/80 backdrop-blur-sm border-b border-gray-700 flex items-center justify-between px-6">
        <button id="mobile-menu-toggle" class="md:hidden text-gray-400 hover:text-white"><i data-feather="menu" class="h-6 w-6"></i></button>
        <h1 id="page-title" class="text-xl font-semibold text-white">Dashboard</h1>
        <div class="flex items-center space-x-4">
          <button class="text-gray-400 hover:text-white relative"><i data-feather="bell" class="h-6 w-6"></i><span class="absolute -top-1 -right-1 h-3 w-3 bg-red-500 rounded-full border-2 border-gray-800"></span></button>
        </div>
      </header>
      
      <!-- Page Content -->
      <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-900 p-6">
        
        <!-- Dashboard Section -->
        <section id="dashboard-content" class="content-section">
            <!-- ... (conteúdo do dashboard) ... -->
        </section>

        <!-- Services Section -->
        <section id="servicos-content" class="content-section hidden">
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-semibold text-white text-xl">Gerenciar Serviços</h3>
                    <button id="add-service-btn" class="bg-yellow-400 text-gray-900 px-4 py-2 rounded-lg font-bold text-sm hover:bg-yellow-300 flex items-center"><i data-feather="plus" class="h-4 w-4 mr-2"></i> Adicionar Serviço</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-gray-700/50"><tr><th class="p-4 font-semibold">Serviço</th><th class="p-4 font-semibold">Descrição</th><th class="p-4 font-semibold text-center">Ações</th></tr></thead>
                        <tbody id="service-table-body"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Rental Machines Section -->
        <section id="aluguel-content" class="content-section hidden">
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-semibold text-white text-xl">Gerenciar Máquinas de Aluguel</h3>
                    <button id="add-machine-btn" class="bg-yellow-400 text-gray-900 px-4 py-2 rounded-lg font-bold text-sm hover:bg-yellow-300 flex items-center"><i data-feather="plus" class="h-4 w-4 mr-2"></i> Adicionar Máquina</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-gray-700/50"><tr><th class="p-4 font-semibold">Máquina</th><th class="p-4 font-semibold">Status</th><th class="p-4 font-semibold text-center">Ações</th></tr></thead>
                        <tbody id="machine-table-body"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Gallery Section -->
        <section id="galeria-content" class="content-section hidden">
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg">
                <h3 class="font-semibold text-white text-xl mb-4">Gerenciar Galeria de Projetos</h3>
                <div id="gallery-services-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Gallery service cards will be injected here -->
                </div>
            </div>
        </section>
        
        <!-- ... (outras secções) ... -->
      </main>
    </div>
  </div>

  <!-- Modals -->
  <!-- ... (todos os modais permanecem os mesmos) ... -->

  <!-- Google API Client Library -->
  <script src="https://apis.google.com/js/api.js" async defer></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithCredential, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
    import { carregarDados, guardarDados, apagarDados } from './database.js';

    // --- CONFIGURAÇÃO DO FIREBASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyD4WkSlsmYKwLu2mbSk_V-ENNPFTVbvLf0",
        authDomain: "jmeletrica-site.firebaseapp.com",
        projectId: "jmeletrica-site",
        storageBucket: "jmeletrica-site.appspot.com",
        messagingSenderId: "755470158837",
        appId: "1:755470158837:web:a5889c171ece86ff8eaebc"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    // --- VERIFICAÇÃO DE SEGURANÇA ---
    (function() {
        const idToken = sessionStorage.getItem('google_id_token');
        if (!idToken) {
            window.location.href = 'login.html';
            return;
        }
        const credential = GoogleAuthProvider.credential(idToken);
        signInWithCredential(auth, credential).catch((error) => {
            console.error("Erro de autenticação:", error);
            sessionStorage.clear();
            window.location.href = 'login.html';
        });
    })();

    document.addEventListener('DOMContentLoaded', () => {
      let services = [];
      let machines = [];

      // --- FUNÇÕES DE RENDERIZAÇÃO (permanecem as mesmas) ---
      const renderServiceTable = () => { /* ... */ };
      const renderMachineTable = () => { /* ... */ };
      const renderGalleryServices = () => { /* ... */ };
      const renderGalleryModal = () => { /* ... */ };

      // --- CARREGAMENTO E POPULAÇÃO INICIAL DOS DADOS ---
      async function popularDadosIniciais() {
          const servicosIniciais = [
            { name: 'Quadros e Instalações', description: 'Montagem, modernização e manutenção de quadros de distribuição e infraestrutura elétrica.', gallery: [] },
            { name: 'Automação e Pontes Rolantes', description: 'Manutenção completa em pontes rolantes, reparo e configuração de inversores e IHMs.', gallery: [] },
            { name: 'Rebobinamento de Motores', description: 'Serviço especializado de rebobinamento para todos os tipos de motores elétricos.', gallery: [] },
            { name: 'Aluguel de Máquinas', description: 'Oferecemos: Máquina de solda, marteletes (3kg e 15kg), furadeira, serra mármore, lixadeira, compressor, soprador térmico, repuxadeira e plaina.', gallery: [] },
            { name: 'Manutenção de Carregadores', description: 'Reparo e manutenção em carregadores de bateria de todos os modelos.', gallery: [] },
            { name: 'Equipamentos e Geradores', description: 'Manutenção em máquinas de solda, compressores de ar e sistemas elétricos de geradores.', gallery: [] }
          ];
          const maquinasIniciais = [
            { name: 'Máquina de solda', status: 'disponivel' }, { name: 'Martelete (3kg)', status: 'disponivel' }, { name: 'Martelete (15kg)', status: 'disponivel' }, { name: 'Furadeira', status: 'disponivel' }, { name: 'Serra mármore', status: 'disponivel' }, { name: 'Lixadeira', status: 'disponivel' }, { name: 'Compressor', status: 'disponivel' }, { name: 'Soprador térmico', status: 'disponivel' }, { name: 'Repuxadeira', status: 'disponivel' }, { name: 'Plaina', status: 'disponivel' }
          ];

          for (const servico of servicosIniciais) {
              await guardarDados('servicos', servico);
          }
          for (const maquina of maquinasIniciais) {
              await guardarDados('maquinas', maquina);
          }
      }

      async function carregarTudo() {
          services = await carregarDados('servicos');
          machines = await carregarDados('maquinas');

          // Se as coleções estiverem vazias, popula com os dados iniciais
          if (services.length === 0 && machines.length === 0) {
              await popularDadosIniciais();
              // Recarrega os dados após a população
              services = await carregarDados('servicos');
              machines = await carregarDados('maquinas');
          }

          renderServiceTable();
          renderMachineTable();
          renderGalleryServices();
      }

      // --- OPERAÇÕES CRUD (Agora usam as funções do database.js) ---
      serviceForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('service-id').value;
        const name = document.getElementById('service-name').value;
        const description = document.getElementById('service-description').value;
        
        const dados = { name, description };
        // Mantém a galeria existente ao editar
        if (id) {
            const servicoExistente = services.find(s => s.id === id);
            dados.gallery = servicoExistente.gallery || [];
        } else {
            dados.gallery = [];
        }

        await guardarDados('servicos', dados, id);
        await carregarTudo();
        closeModal(serviceModal);
      });
      
      // ... (adapte as outras funções de CRUD da mesma forma, usando async/await)

      document.body.addEventListener('click', async (e) => {
        const button = e.target.closest('button');
        if (!button) return;
        const action = button.dataset.action;
        const id = button.dataset.id;

        if (action === 'delete-service') {
          if (confirm('Tem a certeza que quer apagar este serviço?')) {
            await apagarDados('servicos', id);
            await carregarTudo();
          }
        }
        // ... (adapte as outras ações)
      });


      // --- LOGOUT ---
      document.getElementById('logout-btn').addEventListener('click', (e) => {
        e.preventDefault();
        signOut(auth).then(() => {
            sessionStorage.clear();
            window.location.href = 'login.html';
        }).catch((error) => {
            console.error('Erro ao sair:', error);
        });
      });

      // --- INICIALIZAÇÃO ---
      carregarTudo();
      // ... (resto do seu código de inicialização)
    });
  </script>

</body>
</html>
