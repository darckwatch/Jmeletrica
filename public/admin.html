<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Painel Administrativo | JM Elétrica</title>
  
  <!-- Tailwind CSS, Fonts, Icons -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/feather-icons"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* Custom styles for the admin panel */
    body { font-family: 'Inter', sans-serif; background-color: #111827; color: #F3F4F6; }
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #1f2937; }
    ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; }
    .sidebar-link.active { background-color: #facc15; color: #111827; font-weight: 600; }
    .modal-backdrop { transition: opacity 0.3s ease; }
    .modal-content { transition: transform 0.3s ease; }
    .status-badge { padding: 4px 12px; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
    .status-disponivel { background-color: rgba(52, 211, 153, 0.1); color: #34d399; }
    .status-alugada { background-color: rgba(251, 146, 60, 0.1); color: #fb923c; }
    .status-manutencao { background-color: rgba(248, 113, 113, 0.1); color: #f87171; }
    .gallery-image-container { position: relative; }
    .gallery-image-overlay { position: absolute; top: 0; right: 0; bottom: 0; left: 0; background-color: rgba(0,0,0,0.5); opacity: 0; transition: opacity 0.2s ease-in-out; display: flex; align-items: center; justify-content: center; }
    .gallery-image-container:hover .gallery-image-overlay { opacity: 1; }
  </style>
</head>
<body class="antialiased">

  <div class="flex h-screen bg-gray-900">
    <!-- Sidebar Navigation -->
    <aside id="sidebar" class="w-64 bg-gray-800 border-r border-yellow-500/20 flex-shrink-0 flex-col transition-transform duration-300 ease-in-out md:flex -translate-x-full md:translate-x-0 fixed md:relative z-40 h-full">
      <div class="h-20 flex items-center justify-center border-b border-gray-700">
        <a href="#" class="text-3xl font-bold text-yellow-400">
          JM Elétrica <span class="text-lg font-normal text-gray-400 block -mt-2 text-center">Admin</span>
        </a>
      </div>
      <nav class="flex-1 px-4 py-6 space-y-2">
        <a href="#dashboard" class="sidebar-link active flex items-center px-4 py-3 rounded-lg text-gray-300 hover:bg-gray-700 transition-colors"><i data-feather="home" class="h-5 w-5 mr-3"></i> Dashboard</a>
        <a href="#servicos" class="sidebar-link flex items-center px-4 py-3 rounded-lg text-gray-300 hover:bg-gray-700 transition-colors"><i data-feather="tool" class="h-5 w-5 mr-3"></i> Serviços</a>
        <a href="#aluguel" class="sidebar-link flex items-center px-4 py-3 rounded-lg text-gray-300 hover:bg-gray-700 transition-colors"><i data-feather="truck" class="h-5 w-5 mr-3"></i> Aluguel</a>
        <a href="#galeria" class="sidebar-link flex items-center px-4 py-3 rounded-lg text-gray-300 hover:bg-gray-700 transition-colors"><i data-feather="image" class="h-5 w-5 mr-3"></i> Galeria</a>
        <a href="#diagnosticos" class="sidebar-link flex items-center px-4 py-3 rounded-lg text-gray-300 hover:bg-gray-700 transition-colors"><i data-feather="cpu" class="h-5 w-5 mr-3"></i> Diagnósticos IA</a>
        <a href="#configuracoes" class="sidebar-link flex items-center px-4 py-3 rounded-lg text-gray-300 hover:bg-gray-700 transition-colors"><i data-feather="settings" class="h-5 w-5 mr-3"></i> Configurações</a>
      </nav>
      <div class="p-4 border-t border-gray-700">
        <div class="flex items-center">
          <img id="user-avatar" class="h-10 w-10 rounded-full object-cover" src="https://placehold.co/100x100/1f2937/facc15?text=A" alt="[Avatar do Admin]">
          <div class="ml-3">
            <p id="user-name" class="text-sm font-semibold text-white">Admin</p>
            <a href="#" id="logout-btn" class="text-xs text-red-400 hover:text-red-300">Sair</a>
          </div>
        </div>
      </div>
    </aside>

    <!-- Main Content Area -->
    <div class="flex-1 flex flex-col overflow-hidden">
      <!-- Header -->
      <header class="h-20 bg-gray-800/80 backdrop-blur-sm border-b border-gray-700 flex items-center justify-between px-6">
        <button id="mobile-menu-toggle" class="md:hidden text-gray-400 hover:text-white"><i data-feather="menu" class="h-6 w-6"></i></button>
        <h1 id="page-title" class="text-xl font-semibold text-white">Dashboard</h1>
        <div class="flex items-center space-x-4">
          <button class="text-gray-400 hover:text-white relative"><i data-feather="bell" class="h-6 w-6"></i><span class="absolute -top-1 -right-1 h-3 w-3 bg-red-500 rounded-full border-2 border-gray-800"></span></button>
        </div>
      </header>
      
      <!-- Page Content -->
      <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-900 p-6">
        
        <!-- Dashboard Section -->
        <section id="dashboard-content" class="content-section">
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg">
                <h3 class="font-semibold text-white mb-4">Tráfego do Site (Últimos 30 dias)</h3>
                <canvas id="trafficChart"></canvas>
            </div>
        </section>

        <!-- Services Section -->
        <section id="servicos-content" class="content-section hidden">
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-semibold text-white text-xl">Gerenciar Serviços</h3>
                    <button id="add-service-btn" class="bg-yellow-400 text-gray-900 px-4 py-2 rounded-lg font-bold text-sm hover:bg-yellow-300 flex items-center"><i data-feather="plus" class="h-4 w-4 mr-2"></i> Adicionar Serviço</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-gray-700/50"><tr><th class="p-4 font-semibold">Serviço</th><th class="p-4 font-semibold">Descrição</th><th class="p-4 font-semibold text-center">Ações</th></tr></thead>
                        <tbody id="service-table-body"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Rental Machines Section -->
        <section id="aluguel-content" class="content-section hidden">
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-semibold text-white text-xl">Gerenciar Máquinas de Aluguel</h3>
                    <button id="add-machine-btn" class="bg-yellow-400 text-gray-900 px-4 py-2 rounded-lg font-bold text-sm hover:bg-yellow-300 flex items-center"><i data-feather="plus" class="h-4 w-4 mr-2"></i> Adicionar Máquina</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-gray-700/50"><tr><th class="p-4 font-semibold">Máquina</th><th class="p-4 font-semibold">Status</th><th class="p-4 font-semibold text-center">Ações</th></tr></thead>
                        <tbody id="machine-table-body"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Gallery Section -->
        <section id="galeria-content" class="content-section hidden">
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg">
                <h3 class="font-semibold text-white text-xl mb-4">Gerenciar Galeria de Projetos</h3>
                <div id="gallery-services-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Gallery service cards will be injected here -->
                </div>
            </div>
        </section>
        
        <!-- Other sections -->
      </main>
    </div>
  </div>

  <!-- Modals -->
  <div id="service-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 modal-backdrop hidden opacity-0">
    <div class="bg-gray-800 rounded-xl shadow-2xl w-full max-w-lg m-4 modal-content transform scale-95">
        <div class="flex justify-between items-center p-6 border-b border-gray-700"><h3 id="service-modal-title" class="text-xl font-semibold text-white"></h3><button class="text-gray-400 hover:text-white" data-close-modal><i data-feather="x" class="h-6 w-6"></i></button></div>
        <form id="service-form" class="p-6 space-y-4"><input type="hidden" id="service-id"><div><label for="service-name" class="block text-sm font-medium text-gray-300 mb-1">Nome do Serviço</label><input type="text" id="service-name" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white focus:outline-none focus:ring-2 focus:ring-yellow-400" required></div><div><label for="service-description" class="block text-sm font-medium text-gray-300 mb-1">Descrição</label><textarea id="service-description" rows="4" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white focus:outline-none focus:ring-2 focus:ring-yellow-400" required></textarea></div><div class="flex justify-end pt-4"><button type="button" class="text-gray-300 hover:bg-gray-700 px-4 py-2 rounded-lg mr-2" data-close-modal>Cancelar</button><button type="submit" class="bg-yellow-400 text-gray-900 px-4 py-2 rounded-lg font-bold hover:bg-yellow-300">Salvar Serviço</button></div></form>
    </div>
  </div>

  <div id="machine-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 modal-backdrop hidden opacity-0">
    <div class="bg-gray-800 rounded-xl shadow-2xl w-full max-w-lg m-4 modal-content transform scale-95">
        <div class="flex justify-between items-center p-6 border-b border-gray-700"><h3 id="machine-modal-title" class="text-xl font-semibold text-white"></h3><button class="text-gray-400 hover:text-white" data-close-modal><i data-feather="x" class="h-6 w-6"></i></button></div>
        <form id="machine-form" class="p-6 space-y-4"><input type="hidden" id="machine-id"><div><label for="machine-name" class="block text-sm font-medium text-gray-300 mb-1">Nome da Máquina</label><input type="text" id="machine-name" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white focus:outline-none focus:ring-2 focus:ring-yellow-400" required></div><div><label for="machine-status" class="block text-sm font-medium text-gray-300 mb-1">Status</label><select id="machine-status" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white focus:outline-none focus:ring-2 focus:ring-yellow-400" required><option value="disponivel">Disponível</option><option value="alugada">Alugada</option><option value="manutencao">Manutenção</option></select></div><div class="flex justify-end pt-4"><button type="button" class="text-gray-300 hover:bg-gray-700 px-4 py-2 rounded-lg mr-2" data-close-modal>Cancelar</button><button type="submit" class="bg-yellow-400 text-gray-900 px-4 py-2 rounded-lg font-bold hover:bg-yellow-300">Salvar Máquina</button></div></form>
    </div>
  </div>

  <div id="gallery-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 modal-backdrop hidden opacity-0">
    <div class="bg-gray-800 rounded-xl shadow-2xl w-full max-w-3xl m-4 modal-content transform scale-95">
        <div class="flex justify-between items-center p-6 border-b border-gray-700"><h3 id="gallery-modal-title" class="text-xl font-semibold text-white">Gerenciar Galeria</h3><button class="text-gray-400 hover:text-white" data-close-modal><i data-feather="x" class="h-6 w-6"></i></button></div>
        <div class="p-6">
            <input type="hidden" id="gallery-service-id">
            <button id="open-drive-picker" class="w-full bg-blue-600 text-white px-5 py-3 rounded-lg font-bold hover:bg-blue-700 flex items-center justify-center mb-6">
                <i data-feather="folder" class="h-5 w-5 mr-3"></i> Selecionar do Google Drive
            </button>
            <div id="gallery-images-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 max-h-[50vh] overflow-y-auto">
                <!-- Gallery images for the selected service will be injected here -->
            </div>
        </div>
    </div>
  </div>

  <!-- Google API Client Library -->
  <script src="https://apis.google.com/js/api.js" async defer></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithCredential, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
    import { carregarDados, guardarDados, apagarDados } from './database.js';

    // --- CONFIGURAÇÃO DO FIREBASE (deve corresponder ao database.js) ---
    const firebaseConfig = {
      apiKey: "SUA_API_KEY",
      authDomain: "SEU_AUTH_DOMAIN",
      projectId: "SEU_PROJECT_ID",
      storageBucket: "SEU_STORAGE_BUCKET",
      messagingSenderId: "SEU_MESSAGING_SENDER_ID",
      appId: "SEU_APP_ID"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    // --- VERIFICAÇÃO DE SEGURANÇA ---
    (async function() {
        const idToken = sessionStorage.getItem('google_id_token');
        if (!idToken) {
            window.location.href = 'login.html';
            return;
        }
        try {
            const credential = GoogleAuthProvider.credential(idToken);
            await signInWithCredential(auth, credential);
        } catch (error) {
            console.error("Erro de autenticação:", error);
            sessionStorage.clear();
            window.location.href = 'login.html';
        }
    })();

    document.addEventListener('DOMContentLoaded', async () => {
      let services = [];
      let machines = [];

      // --- FUNÇÕES DE RENDERIZAÇÃO ---
      const renderServiceTable = () => {
        const tableBody = document.getElementById('service-table-body');
        tableBody.innerHTML = '';
        services.forEach(service => {
          const row = `
            <tr class="border-b border-gray-700">
              <td class="p-4 font-medium">${service.name}</td>
              <td class="p-4 text-gray-400">${service.description}</td>
              <td class="p-4 text-center space-x-2">
                <button class="text-blue-400 hover:text-blue-300 p-2" data-action="edit-service" data-id="${service.id}"><i data-feather="edit" class="h-5 w-5 pointer-events-none"></i></button>
                <button class="text-red-400 hover:text-red-300 p-2" data-action="delete-service" data-id="${service.id}"><i data-feather="trash-2" class="h-5 w-5 pointer-events-none"></i></button>
              </td>
            </tr>`;
          tableBody.insertAdjacentHTML('beforeend', row);
        });
        feather.replace();
      };
      
      const renderMachineTable = () => {
        const tableBody = document.getElementById('machine-table-body');
        const statusClasses = {disponivel: 'status-disponivel',alugada: 'status-alugada',manutencao: 'status-manutencao'};
        const statusText = {disponivel: 'Disponível',alugada: 'Alugada',manutencao: 'Manutenção'}
        tableBody.innerHTML = '';
        machines.forEach(machine => {
          const row = `
            <tr class="border-b border-gray-700">
              <td class="p-4 font-medium">${machine.name}</td>
              <td class="p-4"><span class="status-badge ${statusClasses[machine.status]}">${statusText[machine.status]}</span></td>
              <td class="p-4 text-center space-x-2">
                <button class="text-blue-400 hover:text-blue-300 p-2" data-action="edit-machine" data-id="${machine.id}"><i data-feather="edit" class="h-5 w-5 pointer-events-none"></i></button>
                <button class="text-red-400 hover:text-red-300 p-2" data-action="delete-machine" data-id="${machine.id}"><i data-feather="trash-2" class="h-5 w-5 pointer-events-none"></i></button>
              </td>
            </tr>`;
          tableBody.insertAdjacentHTML('beforeend', row);
        });
        feather.replace();
      };

      const renderGalleryServices = () => { /* ... (função completa aqui) ... */ };
      const renderGalleryModal = () => { /* ... (função completa aqui) ... */ };

      // --- CARREGAMENTO E POPULAÇÃO INICIAL DOS DADOS ---
      async function popularDadosIniciais() {
          const servicosIniciais = [
            { name: 'Quadros e Instalações', description: 'Montagem, modernização e manutenção de quadros de distribuição e infraestrutura elétrica.', gallery: [] },
            { name: 'Automação e Pontes Rolantes', description: 'Manutenção completa em pontes rolantes, reparo e configuração de inversores e IHMs.', gallery: [] },
            { name: 'Rebobinamento de Motores', description: 'Serviço especializado de rebobinamento para todos os tipos de motores elétricos.', gallery: [] },
            { name: 'Aluguel de Máquinas', description: 'Oferecemos: Máquina de solda, marteletes (3kg e 15kg), furadeira, serra mármore, lixadeira, compressor, soprador térmico, repuxadeira e plaina.', gallery: [] },
            { name: 'Manutenção de Carregadores', description: 'Reparo e manutenção em carregadores de bateria de todos os modelos.', gallery: [] },
            { name: 'Equipamentos e Geradores', description: 'Manutenção em máquinas de solda, compressores de ar e sistemas elétricos de geradores.', gallery: [] }
          ];
          const maquinasIniciais = [
            { name: 'Máquina de solda', status: 'disponivel' }, { name: 'Martelete (3kg)', status: 'disponivel' }, { name: 'Martelete (15kg)', status: 'disponivel' }, { name: 'Furadeira', status: 'disponivel' }, { name: 'Serra mármore', status: 'disponivel' }, { name: 'Lixadeira', status: 'disponivel' }, { name: 'Compressor', status: 'disponivel' }, { name: 'Soprador térmico', status: 'disponivel' }, { name: 'Repuxadeira', status: 'disponivel' }, { name: 'Plaina', status: 'disponivel' }
          ];

          for (const servico of servicosIniciais) { await guardarDados('servicos', servico); }
          for (const maquina of maquinasIniciais) { await guardarDados('maquinas', maquina); }
      }

      async function carregarTudo() {
          services = await carregarDados('servicos');
          machines = await carregarDados('maquinas');

          if (services.length === 0 && machines.length === 0) {
              await popularDadosIniciais();
              services = await carregarDados('servicos');
              machines = await carregarDados('maquinas');
          }

          renderServiceTable();
          renderMachineTable();
          renderGalleryServices();
      }

      // --- OPERAÇÕES CRUD ---
      const serviceForm = document.getElementById('service-form');
      serviceForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('service-id').value;
        const name = document.getElementById('service-name').value;
        const description = document.getElementById('service-description').value;
        
        const dados = { name, description };
        if (id) {
            const servicoExistente = services.find(s => s.id === id);
            dados.gallery = servicoExistente.gallery || [];
        } else {
            dados.gallery = [];
        }

        await guardarDados('servicos', dados, id);
        await carregarTudo();
        closeModal(document.getElementById('service-modal'));
      });
      
      const machineForm = document.getElementById('machine-form');
      machineForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('machine-id').value;
        const name = document.getElementById('machine-name').value;
        const status = document.getElementById('machine-status').value;
        
        const dados = { name, status };
        await guardarDados('maquinas', dados, id);
        await carregarTudo();
        closeModal(document.getElementById('machine-modal'));
      });

      document.body.addEventListener('click', async (e) => {
        const button = e.target.closest('button');
        if (!button) return;
        const action = button.dataset.action;
        const id = button.dataset.id;
        if (!action || !id) return;

        if (action === 'delete-service') {
          if (confirm('Tem a certeza que quer apagar este serviço?')) {
            await apagarDados('servicos', id);
            await carregarTudo();
          }
        }
        if (action === 'delete-machine') {
          if (confirm('Tem a certeza que quer apagar esta máquina?')) {
            await apagarDados('maquinas', id);
            await carregarTudo();
          }
        }
      });


      // --- LOGOUT ---
      document.getElementById('logout-btn').addEventListener('click', (e) => {
        e.preventDefault();
        signOut(auth).then(() => {
            sessionStorage.clear();
            window.location.href = 'login.html';
        }).catch((error) => {
            console.error('Erro ao sair:', error);
        });
      });

      // --- INICIALIZAÇÃO ---
      await carregarTudo();
    });
  </script>

</body>
</html>
